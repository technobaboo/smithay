<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Composition for `Element`s using drm planes"><title>smithay::backend::drm::compositor - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../static.files/rustdoc-f3501f0f5ae15dfb.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../../../" data-static-root-path="../../../../static.files/" data-current-crate="smithay" data-themes="" data-resource-suffix="" data-rustdoc-version="1.71.0-nightly (1a5f8bce7 2023-05-26)" data-search-js="search-4926e5fc22a5646a.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../../../../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../../../../static.files/main-f0540c1d82cde29b.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../../smithay/index.html"><img class="rust-logo" src="../../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../../smithay/index.html"><img class="rust-logo" src="../../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module compositor</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../../index.html">smithay</a>::<wbr><a href="../../index.html">backend</a>::<wbr><a href="../index.html">drm</a>::<wbr><a class="mod" href="#">compositor</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../../src/smithay/backend/drm/compositor/mod.rs.html#1-3252">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Composition for <a href="../../renderer/element/trait.Element.html" title="trait smithay::backend::renderer::element::Element"><code>Element</code></a>s using drm planes</p>
<p>When possible composition can be (partially) offloaded to the display driver by assigning
elements to drm planes. This is especially important for latency intensive fullscreen clients
like video renderers or games.</p>
<p>The <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a> does so by walking the stack of provided <a href="../../renderer/element/trait.Element.html" title="trait smithay::backend::renderer::element::Element"><code>Element</code></a>s from front to back
while trying to assign each element to a drm overlay plane. Each item that fails the plane test
will be rendered on the primary plane using the provided <a href="../../renderer/trait.Renderer.html" title="trait smithay::backend::renderer::Renderer"><code>Renderer</code></a>.
Additionally it will try to assign the top most element that fit’s into the cursor size (as specified
by the <a href="../struct.DrmDevice.html" title="struct smithay::backend::drm::DrmDevice"><code>DrmDevice</code></a>) on the cursor plane. If the element can not be
directly scanned out the renderer will be used to render the element into an <a href="../../renderer/trait.Offscreen.html" title="trait smithay::backend::renderer::Offscreen"><code>Offscreen</code></a> buffer that
is copied over to the allocated gbm buffer for the cursor plane.</p>
<p>Note: While the <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a> also works on <em>legacy</em> drm the use of overlay and cursor planes is disabled in that case.
Direct scan-out will only work with an atomic <a href="../struct.DrmSurface.html" title="struct smithay::backend::drm::DrmSurface"><code>DrmSurface</code></a>.</p>
<h3 id="what-makes-a-element-eligible-for-direct-scan-out"><a href="#what-makes-a-element-eligible-for-direct-scan-out">What makes a <code>Element</code> eligible for direct scan-out</a></h3><h4 id="general"><a href="#general">General</a></h4>
<p>First the element has to provide a <a href="../../renderer/element/enum.UnderlyingStorage.html" title="enum smithay::backend::renderer::element::UnderlyingStorage"><code>UnderlyingStorage</code></a> which can be exported as a drm framebuffer.
Currently this is limited to wayland buffers, but may be extended in the future.
This module provides a default exporter based on <a href="gbm/index.html" title="mod smithay::backend::drm::compositor::gbm"><code>gbm</code></a> which should fit most use-cases.</p>
<p>If a certain combination of elements works can only be determined by asking the driver by submitting
a atomic commit test. If that test fails the element is scheduled to be rendered on the primary plane.</p>
<h4 id="overlay-planes"><a href="#overlay-planes">Overlay planes</a></h4>
<p>The element can only be directly scanned out if it’s geometry does not overlap with an already assigned
element on a plane higher in the stack.</p>
<h4 id="underlay-planes"><a href="#underlay-planes">Underlay planes</a></h4>
<p>An underlay plane is only used if it does not overlap with an already assigned plane lower in the stack
and the element is fully opaque.</p>
<h4 id="primary-plane"><a href="#primary-plane">Primary plane</a></h4>
<p>For an element to be considered to be directly scanned out on the primary plane it has to be the last remaining
visible element on the output and no other element has been assigned to the primary plane. If there are multiple
element assigned to the primary plane the renderer will be used to composite the primary plane into a allocator
provided buffer. Additionally the element has to be either fully opaque or the clear color has to match the CRTC
background color and no overlap with an underlay is found.</p>
<h2 id="how-to-use-it"><a href="#how-to-use-it">How to use it</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>smithay::{
    backend::drm::{compositor::DrmCompositor, DrmSurface},
    output::{Output, PhysicalProperties, Subpixel},
    utils::Size,
};

<span class="comment">// ...initialize the output, drm device, drm surface and allocator
</span><span class="kw">let </span>output = Output::new(
    <span class="string">&quot;e-DP&quot;</span>.into(),
    PhysicalProperties {
        size: Size::from((<span class="number">800</span>, <span class="number">600</span>)),
        make: <span class="string">&quot;N/A&quot;</span>.into(),
        model: <span class="string">&quot;N/A&quot;</span>.into(),
        subpixel: Subpixel::Unknown,
    },
);

<span class="kw">let </span><span class="kw-2">mut </span>compositor: DrmCompositor&lt;<span class="kw">_</span>, <span class="kw">_</span>, (), <span class="kw">_</span>&gt; = DrmCompositor::new(
    <span class="kw-2">&amp;</span>output,
    surface,
    <span class="prelude-val">None</span>,
    allocator,
    exporter,
    color_formats,
    renderer_formats,
    device.cursor_size(),
    <span class="prelude-val">Some</span>(gbm),
)
.expect(<span class="string">&quot;failed to initialize drm compositor&quot;</span>);

<span class="kw">let </span>render_frame_result = compositor
    .render_frame::&lt;<span class="kw">_</span>, <span class="kw">_</span>, GlesTexture&gt;(<span class="kw-2">&amp;mut </span>renderer, <span class="kw-2">&amp;</span>elements, CLEAR_COLOR)
    .expect(<span class="string">&quot;failed to render frame&quot;</span>);

<span class="kw">if </span>render_frame_result.damage.is_some() {
    compositor.queue_frame(()).expect(<span class="string">&quot;failed to queue frame&quot;</span>);

    <span class="comment">// ...wait for VBlank event

    </span>compositor
        .frame_submitted()
        .expect(<span class="string">&quot;failed to mark frame as submitted&quot;</span>);
} <span class="kw">else </span>{
    <span class="comment">// ...re-schedule frame
</span>}</code></pre></div>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="gbm/index.html" title="mod smithay::backend::drm::compositor::gbm">gbm</a></div><div class="desc docblock-short">Implementation for ExportFramebuffer and related utilizies for gbm types</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor">DrmCompositor</a></div><div class="desc docblock-short">Composite an output using a combination of planes and rendering</div></li><li><div class="item-name"><a class="struct" href="struct.PrimarySwapchainElement.html" title="struct smithay::backend::drm::compositor::PrimarySwapchainElement">PrimarySwapchainElement</a></div><div class="desc docblock-short">Defines the element for the primary plane in cases where a composited buffer was used.</div></li><li><div class="item-name"><a class="struct" href="struct.RenderFrameResult.html" title="struct smithay::backend::drm::compositor::RenderFrameResult">RenderFrameResult</a></div><div class="desc docblock-short">Result for <a href="struct.DrmCompositor.html#method.render_frame" title="method smithay::backend::drm::compositor::DrmCompositor::render_frame"><code>DrmCompositor::render_frame</code></a></div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.BlitFrameResultError.html" title="enum smithay::backend::drm::compositor::BlitFrameResultError">BlitFrameResultError</a></div><div class="desc docblock-short">Error for <a href="struct.RenderFrameResult.html#method.blit_frame_result" title="method smithay::backend::drm::compositor::RenderFrameResult::blit_frame_result"><code>RenderFrameResult::blit_frame_result</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.ExportBuffer.html" title="enum smithay::backend::drm::compositor::ExportBuffer">ExportBuffer</a></div><div class="desc docblock-short">Possible buffers to export as a framebuffer using <a href="trait.ExportFramebuffer.html" title="trait smithay::backend::drm::compositor::ExportFramebuffer"><code>ExportFramebuffer</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.FrameError.html" title="enum smithay::backend::drm::compositor::FrameError">FrameError</a></div><div class="desc docblock-short">Errors thrown by a <a href="struct.DrmCompositor.html" title="struct smithay::backend::drm::compositor::DrmCompositor"><code>DrmCompositor</code></a></div></li><li><div class="item-name"><a class="enum" href="enum.PrimaryPlaneElement.html" title="enum smithay::backend::drm::compositor::PrimaryPlaneElement">PrimaryPlaneElement</a></div><div class="desc docblock-short">Defines the element for the primary plane</div></li><li><div class="item-name"><a class="enum" href="enum.RenderFrameError.html" title="enum smithay::backend::drm::compositor::RenderFrameError">RenderFrameError</a></div><div class="desc docblock-short">Error returned from <a href="struct.DrmCompositor.html#method.render_frame" title="method smithay::backend::drm::compositor::DrmCompositor::render_frame"><code>DrmCompositor::render_frame</code></a></div></li></ul><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.ExportFramebuffer.html" title="trait smithay::backend::drm::compositor::ExportFramebuffer">ExportFramebuffer</a></div><div class="desc docblock-short">Export a <a href="enum.ExportBuffer.html" title="enum smithay::backend::drm::compositor::ExportBuffer"><code>ExportBuffer</code></a> as a framebuffer</div></li></ul></section></div></main></body></html>